---
layout: single
title: 동기와 비동기 & 블락과 논블락
categories: 
  - socket
tags: 
  - socket
  - i/o
---

### 블락(block) vs 논블락(non-block)
- 블락/논블락은 함수 호출에서의 이야기 이다. (기술적으로 명확히 구분됨)
- A라는 함수를 호출(system call)했을 때 기대하는 행위를 모두 마칠때까지 기다렸다가 함수가 리턴되면 블로킹 되었다고 한다.
- 기대하는 행위를 마칠때까지 기다리지 않고 행위 요청 후 바로 리턴이 되면 논블락킹되었다고 한다.
- 'O_NONBLOCK' 플래그를 이용해 non-blocking 모드를 설정한다.

### 동기(synchronous) vs 비동기(asynchronous)
- 동기/비동기는 행위에 대한 이야기이다. (기술적으로 구분 안되고 추상적으로 구분)
- 인과관계가 있는 별개의 A라는 행위와 B라는 행위가 동시에(혹은 비순차적으로) 실행되고 있다면 비동기라고 한다. 여기서 인과관계란 예를들어 멀티쓰레드와 같은 것을 의미한다.
- A와 B 행위가 순차적으로 작동한다면 동기라고 한다. 또는 A라는 행위가 별개의 것이 아니라 B라는 행위를 관찰하는 행위라면 이것이 동시에 일어나더라도 동기이다. 예를들어 쓰레드 A와 B가 따로 돌아간다고 하더라도 A가 B에 밀착되어 있다면 동기라고 한다.

### 적용
- 소켓은 기본적으로 blocking mode로 동작한다.
- fcnl 함수를 이용하여 file descriptor를 non-blocking 소켓으로 변경할 수 있다.
{% highlight ruby %}
#include <unistd.h>
#include <fctnl.h>

int flag = fcntl(sock_fd, F_GETFL, 0)
fcntl(sock_fd, F_SETFL, flag | O_NONBLOCK)
{% endhighlight %}
+ F_GETFL : 파일 상태의 속성을 return 한다
+ F_SETFL : 파일 상태의 속성을 세번째 인수로 받아 설정한다. 
=> fd의 속성을 변경할 때는 반드시 먼저 flag를 얻어오고(GET) 얻어온 값을 통해 변경(SET)해야 한다. 그렇지 않으면 이전에 설정했던 값은 지워질 수 있다.

### 예시
1. 블럭/동기
- 1번 트럭이 나에게 물건을 가져와달라고 요청하고 기다린다. (block-기다림)
- 나는 물건들을 찾아서 1번트럭에 싣기 시작한다.
- 2번 트럭은 1번트럭에 물건이 다 실리기를 기다린다. (block)
- 3번 트럭도 기다린다. (block)
- 1번 트럭이 물건을 모두 싣고 떠나면, 나는 2번트럭의 물건을 찾아 싣는다. (동기-순차적)

2. 블럭/비동기
- 나는 물건을 파는 가게에 필요한 물건을 말하여 접수하고 집으로 돌아온다.
- 가게는 물건을 준비하고 나는 집에서 청소를 한다. (비동기-동시,인과관계O)
- 가게에 전화해서 물건이 준비되었는지 물어본다. 가게 종업원은 준비될 때 까지 기다리라고 한다. 나는 하염없이 기다린다. (block - 기다림)
- 가게에서 준비가 완료되었다고 말하면 나는 트럭을 가지고 가게로 가서 물건을 실어온다.
- 내가 물건을 실어오는 동안 가게는 자신의 일을 한다. (비동기)

3. 논블럭/동기
- 나는 가게에 필요한 물건을 접수하고 집으로 돌아온다.
- 가게는 물건을 준비하고 나는 전화기를 들고 가게에 전화한다.
- 물건이 준비되었냐고 묻고 가게는 안됐다고 말한다. 나는 전화를 바로 끊는다. (non-block -요청즉시 리턴)
- 전화를 끊고 청소를 하는게 아니라 다시 가게에 전화하고 안됐다고 하면 바로 끊는다.
- 이런식으로 내 일을 하는것이 아니라 계속 반복적으로 전화한다. (non-block, 동기 -순차)

4. 논블럭/비동기
- 나는 가게에 필요한 물건을 접수하고 트럭을 두고 집에 온다. (non-block - 요청즉시 리턴)
만약 트럭(버퍼)이 크다면 가게에서 물건을 많이 실어줄 것이다.
- 가게는 물건을 준비하고 나는 집에와 청소를 한다. (비동기 -동시, 인과관계O)
- 가게로부터 트럭에 물건을 가득 실었다고 연락이 오면 나는 트럭을 가지고 온다. 동시에 가게는 자신의 일을 한다.
- 논블럭과 비동기 방식은 가장 효율적인 방법이다.

=> block/non-block이 동시성과 무관하다는 것만 알면 block/동기 & non-block/비동기 를 함께 묶어서 말해도 무관하다.




